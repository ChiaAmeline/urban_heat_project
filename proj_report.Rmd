---
title: "City Urban Heat Island Effect Project Report"
author:
- CHIA YUE ZHU AMELINE, A0211277L
- GOH WEI JIE DARREN , A0265959E 
- RAKHSHANA PARVEEN , A0227119H 
- WILLIAM JOSE , A0245394X 
date: "2024-11-17"
output:
  word_document:
    reference_docx: TBA4220_custom_template.docx
---

```{r setup, include=FALSE}
options(repos = c(CRAN = "https://cloud.r-project.org"))
knitr::opts_chunk$set(echo = TRUE)
```

# INTRODUCTION
For this report, the **Problem Statement is: Which factors (population density, energy consumption, and green area size) most significantly impact the intensity of urban temperature with city?** With urban cities worldwide experiencing rising temperatures due to industrialization and rapid urbanization, it is crucial to understand and mitigate the factors driving urban heat. Therefore, this project seeks to analyze and predict urban heat island (UHI) intensity by examining how population density, energy consumption, and green space availability contribute to temperature variations across diverse geographic regions.

Using datasets downloaded from Kaggle on temperature, population, energy consumption, and land use, we will explore the correlation between population density and urban temperatures, assess the influence of various environmental and socio-economic variables on UHI, and examine how energy consumption exacerbates UHI effects. By integrating these datasets and conducting exploratory data analysis (EDA), we aim to build predictive models that accurately estimate UHI intensity, enabling policymakers and urban planners to prioritize effective strategies to mitigate UHI impacts.

Ultimately, the findings from this project will provide public policymakers and urban planners with insights into how urban environmental factorsâ€”such as population density, green area size, and energy consumptionâ€”affect temperature variations in cities. These insights can guide the development of strategies for urban heat mitigation, support the creation of climate-adaptive policies, and inform sustainable urban planning practices focused on managing and reducing urban heat intensity.


# BACKGROUND
Urban areas worldwide are experiencing rising temperatures, often due to industrialization and rapid urbanization. For this reason, many urban areas are significantly warmer than their surrounding rural areas. According to a study conducted by the **Queensland University of Technology,** *titled - [Urban heat island effect: A systematic review of spatio-temporal factors, data, methods, and mitigation measures]((https://eprints.qut.edu.au/115400/1/Manuscript%20Accepted%20Version.pdf))*, several factors contribute to UHI, including population density, energy consumption, and the lack of green spaces. This study systematically reviews and highlights how spatial and temporal factors influence temperature intensity and emphasizing the importance to analyze these variables effectively to formulate policies that mitigate the raise in temperature.

## JUSTIFICATION
Building on this knowledge, we aim to advance the research further by exploring how the above three factors intensify UHI effect over time through predictive analysis and by assessing the potential consequences if left unaddressed. Therefore, our reportâ€™s hypothesis posits that high-density urban city areas, combined with extensive built infrastructure (energy consumption) and concentrated human activity (population density), contribute to elevated temperatures through reduced green space areas and increased heat emissions. Without immediate control, this intensification of the UHI effect could accelerate local temperature and lead to more frequent and severe heatwave events in urban areas, posing significant risks to the quality of life.


# DATA
## STEP 01 - DATA COLLECTION
The data used in this project comes from two primary sources: R's Natural Earth data package and Kaggle.

```{r echo=FALSE, warning = FALSE, message = FALSE, include=FALSE}
# Import of libraries
library(tidyverse)
library(dplyr)
library(ggplot2)
library(sf)
library(tmap)
library(measurements)
library(spData)
library(googledrive)
library(readxl)
library(rnaturalearth)
library(rnaturalearthdata)
library(lubridate)
library(plotly)
library(viridis)
library(scales)
library(readr)
library(rlang)
library(corrplot)
library(spatstat)
library(eks)
library(ks)
library(tmap)
library(spdep)
library(spatialreg)
library(GWmodel)
library(patchwork)
library(knitr)

# Downloading the dataset from Google drive using the following function
download_file_fun <- function(file_id) {
  # Download the file to the temporary location
  temp_file <- tempfile(fileext = ".csv")
  drive_download(as_id(file_id), path = temp_file, overwrite = TRUE)
  # Read the CSV file from the temporary location
  return(read_csv(temp_file))
}

# File ID from Google Drive URL (For GlobalLandTemperaturesByCity)
temp_cities_data <- download_file_fun("17lPSwGwt5HTMbIiaTkotfmuKlkKZAPcM")
# File ID from Google Drive URL (For GlobalLandTemperaturesByCountry)
temp_country_data <- download_file_fun("1eUG98W8Mz6OURXim17SEYiFFtsz3oGpG")
# File ID from Google Drive URL (For world_population)
population_data <- download_file_fun("1sAMaGYknHeDDwdTICCsqgfWBXcmw5Wtl")
# File ID from Google Drive URL (For energy)
energy_data <- download_file_fun("1Oha-hiaJZCH9d4jJW-SN5GqcUJew9s1Z")
# File ID from Google Drive URL (For Share_of_green_areas_and_green_area_per_capita_in_cities_and_urban_areas_1990_-_2020)
file_id_temp_green <- "1Yu75p6z9dXVbfIe9n2rb9QU7YBntvsyz"
temp_green <-  tempfile(fileext = ".xlsx")
drive_download(as_id(file_id_temp_green), path = temp_green, overwrite = TRUE)
green_area_data <- read_excel(temp_green)

# Load world and class data from Natural Earth packages to retrieve spatial polygon scales
world_map <- ne_countries(scale = "medium", returnclass = "sf")
world_cities <- ne_download(scale = "medium", type = "populated_places", category = "cultural", returnclass = "sf")
cities_coords <- st_coordinates(world_cities)
world_cities <- cbind(world_cities, cities_coords)

# Combine country and city data
joined_country_city_temp <- left_join(temp_country_data, temp_cities_data, by = c("dt", "Country"))
```

During the data sourcing process, we encountered challenges finding comprehensive spatial polygon dataframes that aligned with our project requirements. Many available datasets we came across on Kaggle and NASA's earth data either lacked polygon scales or, included them but did not contain the spatial attributes needed to address our problem statement. As a result, using R libraries, we downloaded world and city data from the Natural Earth data package and integrated the spatial data libraries with datasets from Kaggle to form the spatial polygon dataframes for our analysis.

On the Kaggle platform, we downloaded five datasets. Specifically:

### **[The country's temperature dataset]((https://www.kaggle.com/datasets/parulpandey/world-coordinates))**: Dataset containing land temperatures of ever country
+---------------------------+-------------------------------------------------+
| Datasets                  | Fields (data type)                              |
+===========================+=================================================+
|                           | - dt (Character)                                |
| Global Land Temperatures  | - country_avg_temp (Numeric)                    |
| by Country                | - country_avg_uncertainty (Numeric)             |
|                           | - country (Character)                           |     
+---------------------------+-------------------------------------------------+

### **[The city's temperature dataset]((https://www.kaggle.com/datasets/berkeleyearth/climate-change-earth-surface-temperature-data?select=GlobalLandTemperaturesByState.csv))**: Dataset containing land temperatures of ever state (city)
+---------------------------+-------------------------------------------------+
| Datasets                  | Fields (data type)                              |
+===========================+=================================================+
|                           | - dt (Character)                                |
|                           | - city_avg_temp (Numeric)                       |
| Global Land Temperatures  | - city_avg_uncertainty (Numeric)                |
| by State                  | - city (Character)                              |     
|                           | - country (Character)                           |   
|                           | - latitude (Character)                          |   
|                           | - longitude (Character)                         |   
+---------------------------+-------------------------------------------------+

### **[The population dataset]((https://www.kaggle.com/datasets/iamsouravbanerjee/world-population-dataset))**: World Population Dataset by Country/Territory
+---------------------------+-------------------------------------------------+
| Datasets                  | Fields (data type)                              |
+===========================+=================================================+
|                           | - Rank (Numeric)                                |
|                           | - CCA3 (Character)                              |
|                           | - Country/Territory (Character)                 |
|                           | - Capital (Character)                           |     
|                           | - Continent (Character)                         |   
|                           | - Area (Numeric)                                |   
| World Population Dataset  | - Density (Numeric)                             |   
|                           | - Growth Rate (Numeric)                         |   
|                           | - World Population Percentage (Numeric)         |   
|                           | - 2022 Population (Numeric)                     |   
|                           | - 2020 Population (Numeric)                     |   
|                           | - 2015 Population (Numeric)                     |   
|                           | - 2010 Population (Numeric)                     |   
|                           | - 2000 Population (Numeric)                     |  
+---------------------------+-------------------------------------------------+

### **[The energy dataset]((https://www.kaggle.com/datasets/lobosi/c02-emission-by-countrys-grouth-and-population))**: Yearly CO2 Emission by each Countrys Energy Consumption/Production, Gross Domestic Product, Population, etc
+---------------------------+-------------------------------------------------+
| Datasets                  | Fields (data type)                              |
+===========================+=================================================+
|                           | - Country (Character)                           |
|                           | - Energy_type (Character)                       |
|                           | - Year (Numeric)                                |
|                           | - Energy_consumption (Numeric)                  |     
| Countries CO2 Emission    | - Energy_production (Numeric)                   |   
| Dataset                   | - GDP (Numeric)                                 |   
|                           | - Population (Numeric)                          |  
|                           | - Energy_intensity_per_capita (Numeric)         |   
|                           | - Energy_intensity_per_GDP (Numeric)            |   
|                           | - CO2_emission (Numeric)                        |   
+---------------------------+-------------------------------------------------+

### **[The green area dataset]((https://data.unhabitat.org/pages/open-spaces-and-green-areas))**: Open spaces and green areas
+---------------------------+----------------------------------------------------------------------+
| Datasets                  | Fields (data type)                                                   |
+===========================+======================================================================+
|                           | - Country or Territorial Name (Character)                            |
|                           | - City Code (Numeric)                                                |
|                           | - City Name (Numeric)                                                |
|                           | - SDG Sub-Region (Character)                                         |     
|                           | - SDG Region (Character)                                             |   
|                           | - Average share of green area in city/urban area 1990 (%) (Numeric)  |   
| Green Area Dataset        | - Average share of green area in city/urban area 2000 (%) (Numeric)  |   
|                           | - Average share of green area in city/urban area 2010 (%) (Numeric)  |   
|                           | - Average share of green area in city/urban area 2020 (%) (Numeric)  |   
|                           | - Green area per capita 1990 (m2/person) (Numeric)                   |   
|                           | - Green area per capita 2000 (m2/person) (Numeric)                   |   
|                           | - Green area per capita 2010 (m2/person) (Numeric)                   |   
|                           | - Green area per capita 2020 (m2/person) (Numeric)                   |   
|                           | - Data Source (Character)                                            |   
|                           | - FootNote (m2/person) (Character)                                   |   
+---------------------------+----------------------------------------------------------------------+

Our analysis examines how population density, energy consumption, and green area size influence temperatures in urban areas, making it essential to investigate temperature variations at a granular level. This will ultimately form the foundation of our analysis work. Furthermore, cities within the same country often experience significant temperature differences due to factors like local conditions or more broadly, proximity to the equator. For this reason, we prioritized and used city temperatures over country-level averages to capture these critical nuances more accurately.

As we obtained the country and city temperature datasets separately, we combined them using a left join on the city's dataset with the country's dataset. Given that we are focusing our analysis on city-level, this merging technique will retain city-specific details and create a city spatial dataframe that is comprehensive for us to start on our analysis. 

### LIMITATION
We recognise the following data limitations in our analysis: 

* **Urban vs. Rural Classification:** The datasets do not explicitly define urban and rural areas. For simplicity, we will assume cities represent urban areas and non-city regions as rural. 
* **Data Precision::** City-specific data for population density and environmental factors are unavailable, as such we will assume uniform distribution across countries. 

## STEP 02 - DATA CLEANING AND TRANSFORMATION
### DATA CLEANING
Throughout the data cleaning process, we perform and executed the following: 

* Removal of NA values
* Check and remove duplicated records
* Renaming of column names
* Removing unnecessary columns that doesnt value add the analysis
* Data type conversion of columns
* **Data transposition:** Our population and energy datasets were initially downloaded in wide format, which is not suitable for time-series analysis. To address this, we transposed both datasets into long format, organizing the data so that each row represents a single observation for a specific country, year, and variable
* **Longitude and Latitude format checks:** To ensure the downloaded longitude and latitude data are within valid ranges and formats, we implemented a regex checker as part of our data validation process. This checker verifies that longitudes are between -180 and 180 degrees and latitudes are between -90 and 90 degrees, thereafter, removing any records that do not meet these criteria. Additionally, we converted the longitude and latitude values from cardinal points to numerical values to facilitate easy plotting of our maps
* **Feature engineer columns:** Our temperature dataset encompasses a significant temporal range, spanning from 1890 to 2013â€”approximately two centuries of data. Visualizing such an extensive time series in a single facet graph is challenging due to the vast number of data points and the potential for overcrowding, which can obscure meaningful patterns and trends. To effectively analyze and present this data, we created two new columnsâ€”'Year' and 'Decade'â€”to group the temperature records into ten-year intervals. This grouping ensures that all data points are accounted for and can be visually represented on the map.
* **Inconsistent data dates in City Temperature dataset:** To ensure consistent time series data across cities and minimize skewness in temperature comparisons, we plotted a map of a 100,000-record sample, which showcased the skewness in data by revealing that cities had varying numbers of unique dates (some with ~1,500 dates, others with ~3,000). To address this, we standardized the dataset by identifying overlapping dates among all cities and removing non-overlapping dates, ensuring that each city had the same number of unique dates (1,450). This resulted in a uniform dataset suitable for accurate analysis and visualization.

```{r echo=FALSE, warning = FALSE, message = FALSE, fig.width=8, fig.height=6, fig.align="center", out.width="100%"}
# Count initial rows per dataset
print("Initial Count")
print(paste("Total number of records for City Temperature Dataset: ", nrow(joined_country_city_temp)))
print(paste("Total number of records for Population Dataset: ", nrow(population_data)))
print(paste("Total number of records for Energy Dataset: ", nrow(energy_data)))
print(paste("Total number of records for Green Area Dataset:  ", nrow(green_area_data)))

# Checking and removing "NA" values if there are any
print(paste("NA present for City Temperature Dataset: ", any(is.na(joined_country_city_temp))))
print(paste("NA present for Population Dataset: ", any(is.na(population_data))))
print(paste("NA present for Energy Dataset: ", any(is.na(energy_data))))
print(paste("NA present for Green Area Dataset: ", any(is.na(green_area_data))))

cleaned_temp_data <- joined_country_city_temp %>% drop_na()
energy_data <- energy_data %>% drop_na()
green_area_data <- green_area_data %>% drop_na()
print("Rechecking for NA")
print(paste("NA present for City Temperature Dataset: ", any(is.na(cleaned_temp_data))))
print(paste("NA present for Population Dataset: ", any(is.na(population_data))))
print(paste("NA present for Energy Dataset: ", any(is.na(energy_data))))
print(paste("NA present for Green Area Dataset: ", any(is.na(green_area_data))))

# Checking and removing duplicated values if there are any
print(paste("Total number of duplicated records in City Temperature Dataset: ", nrow(cleaned_temp_data[duplicated(cleaned_temp_data), ])))
print(paste("Total number of duplicated records in Population Dataset: ", nrow(population_data[duplicated(population_data), ])))
print(paste("Total number of duplicated records in Energy Dataset: ", nrow(energy_data[duplicated(energy_data), ])))
print(paste("Total number of duplicated records in Green Area Dataset: ", nrow(green_area_data[duplicated(green_area_data), ])))

# Rename columns for clarity 
cleaned_temp_data <- cleaned_temp_data %>% rename(
    country_avg_temp = AverageTemperature.x,
    country_temp_uncertainty = AverageTemperatureUncertainty.x, 
    city_avg_temp = AverageTemperature.y,
    city_temp_uncertainty = AverageTemperatureUncertainty.y
  )

# Remove unnecessary column ("...1") in energy dataset
green_area_data <- green_area_data[, -1]

# Check column classes and convert if required
display_column_classes <- function(dataset, dataset_name) {
  column_classes <- sapply(dataset, class)
  column_info <- data.frame(
    Column = names(column_classes),
    Class = as.character(column_classes),
    stringsAsFactors = FALSE
  )
  kable(
    column_info,
    caption = paste(dataset_name, "Column Data Types")
  )
}
display_column_classes(cleaned_temp_data, "City Temperature Dataset")
display_column_classes(population_data, "Population Dataset")
display_column_classes(energy_data, "Energy Dataset")
display_column_classes(green_area_data, "Green Area Dataset")

# Transpose population and energy data
population_data <- population_data %>% pivot_longer(
    cols = ends_with("Population"),          
    names_to = "Year",                       
    names_prefix = "",                       
    values_to = "Population"                
  ) %>% mutate( Year = as.integer(sub(" Population", "", Year)))
green_area_data <- green_area_data %>%
  pivot_longer(
    cols = starts_with("Average share of green area in") |
      starts_with("Green area per capita"),
    names_to = "Year_Metric",
    values_to = "Value"
  ) %>%
  mutate(
    Year = as.integer(str_extract(Year_Metric, "\\d{4}")), 
    Metric = case_when(
      str_detect(Year_Metric, "Average share of green area") ~ "Average_share_of_green_area",
      str_detect(Year_Metric, "Green area per capita") ~ "Green_area_per_capita"
    )
  ) %>%
  select(-Year_Metric) %>%
  pivot_wider(names_from = "Metric", values_from = "Value")

# Checking that lat is within -90 and 90 and log is within -180 and 180
lat_pat <- "^(-?([0-9]{1,2}(\\.\\d+)?))([NS])?$"
lon_pat <- "^(-?([0-9]{1,3}(\\.\\d+)?))([EW])?$"
cleaned_temp_data <- cleaned_temp_data %>% filter(grepl(lat_pat, Latitude), grepl(lon_pat, Longitude))
# Function to clean Latitude
clean_latitude <- function(lat) {
  lat <- trimws(lat)                      # Remove leading/trailing whitespace
  lat <- gsub("N$", "", lat)              # Remove 'N' at the end
  lat <- gsub("S$", "-", lat)             # Replace 'S' at the end and add a negative sign infront
  if (grepl("-$", lat)) {
    lat <- paste0("-", sub("-$", "", lat))
  }
  lat <- gsub("[^0-9.\\-]", "", lat)      # Remove any non-numeric characters except '-' and '.'
  lat <- as.numeric(lat)                  # Convert to numeric
  return(lat)
}
# Function to clean Longitude
clean_longitude <- function(lon) {
  lon <- trimws(lon)                      # Remove leading/trailing whitespace
  lon <- gsub("E$", "", lon)              # Remove 'E' at the end
  lon <- gsub("W$", "-", lon)             # Replace 'W' at the end and add a negative sign infront
  lon <- sub("^-", "-", lon)
  if (grepl("-$", lon)) {
    lon <- paste0("-", sub("-$", "", lon))
  }
  lon <- gsub("[^0-9.\\-]", "", lon)      # Remove any non-numeric characters except '-' and '.'
  lon <- as.numeric(lon)                  # Convert to numeric
  return(lon)
}
# Apply the cleaning functions
cleaned_temp_data$Latitude <- sapply(cleaned_temp_data$Latitude, clean_latitude)
cleaned_temp_data$Longitude <- sapply(cleaned_temp_data$Longitude, clean_longitude)

# Feature engineering a new column for data transformation
cleaned_temp_data$year <- format(cleaned_temp_data$dt, "%Y")
cleaned_temp_data$year <- as.numeric(cleaned_temp_data$year)

# Plotting bar chart to visually check if the cities have differing dates (randomly sampling 100000 records as there are too much data points to plot)
unique_dt_map_fun <- function(data){
  set.seed(1234)
  unique_city_per_dt <- data %>% group_by(City) %>% reframe(nrows_per_dt = n_distinct(dt), Longitude = Longitude, Latitude = Latitude)
  limit_unique_city_per_dt <- unique_city_per_dt %>% sample_n(100000)
  ggplot(limit_unique_city_per_dt) + borders("world", colour = "gray80", fill = "gray90") +
    geom_point(aes(x = Longitude, y = Latitude, color = nrows_per_dt), alpha = 0.7, size = 2) +
    scale_color_viridis_c() + coord_sf(datum = st_crs(4326), crs = "+proj=moll") + 
    labs(
      title = "Total Number of Unique Dates by City",
      x = "Longitude",
      y = "Latitude",
      color = "Count of Dates"
    ) +
    theme_minimal()
}
unique_dt_map_fun(cleaned_temp_data)
# Finding overlapping dates
unique_dt_per_city <- cleaned_temp_data %>% group_by(dt) %>% summarise(nrows_per_city = n_distinct(City), .groups = 'drop')
distinct_cities <- n_distinct(cleaned_temp_data$City)
overlapping_dt <- unique_dt_per_city %>%filter(nrows_per_city == distinct_cities) %>% pull(dt)
# Removing non-overlapping dates
cleaned_temp_data <- cleaned_temp_data %>% filter(dt %in% overlapping_dt)
# Replotting to check if the cities still have differing dates
unique_dt_map_fun(cleaned_temp_data)
```

After cleaning and removing irrelevant data, we are left with the following usable records for each dataset. The count is seen below:

```{r echo=FALSE, warning = FALSE, message = FALSE}
print("Final Count")
print(paste("Total number of records for City Temperature Dataset: ", nrow(joined_country_city_temp)))
print(paste("Total number of records for Population Dataset: ", nrow(population_data)))
print(paste("Total number of records for Energy Dataset: ", nrow(energy_data)))
print(paste("Total number of records for Green Area Dataset:  ", nrow(green_area_data)))
```


## DATA TRANSFORMATION
Once the data had been cleaned, we moved on to the transformation phase. To better understand the data, we plotted maps to determine the spatial distribution of temperature records, identify geographical patterns and anomalies, and assess how temperature trends varied across different regions and decades

```{r echo=FALSE, warning = FALSE, message = FALSE, fig.width=8, fig.height=6, fig.align="center", out.width="80%"}
# Grouping and categorizing each year's decade
cleaned_temp_data$decade <- floor(cleaned_temp_data$year / 10) * 10
avg_temp_across_decade <- cleaned_temp_data %>% group_by(decade, City, Longitude, Latitude) %>% reframe(avg_temp = mean(city_avg_temp, na.rm = TRUE))

ggplot(avg_temp_across_decade) +
  borders("world", colour = "gray80", fill = "gray90") +
  geom_point(aes(x = Longitude, y = Latitude, color = avg_temp), size = 1, alpha = 0.7) +
  scale_color_viridis_c(name = "Avg Temp (Ã¯Â¿Â½C)", limits = c(10, 25), oob = squish) + 
  labs(
    title = "Average Temperature by City Across Decades",
    x = "Longitude",
    y = "Latitude"
  ) +
  facet_wrap(~ decade, ncol = 5) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 8),
    plot.title = element_text(hjust = 0.5),
    legend.position = "right"
  )
```

**Analysis/Observation:** Based on the above maps, the facet analysis of average temperatures across cities by decade clearly reveals a gradual warming trend over the past two centuries, thereby supporting the hypothesis that urban temperatures have increased over time. Specifically, when comparing maps from 1890 and 2010, we observe that cities near the equator, initially shaded in green, have shifted to warmer tones (yellow or light green) by 2010, indicating a discernible rise in temperature. To ensure our analysis remains relevant to the present, we applied an exponentially weighted average transformation, placing greater emphasis on data from the 20th century onward.

```{r echo=FALSE, warning = FALSE, message = FALSE, include=FALSE}
unique_years <- unique(cleaned_temp_data$year)
unique_years <- sort(unique_years, decreasing = TRUE)
weighted_avg_func <- function(avg_temperatures, year){
  index <- match(year, unique_years)
  w <- 1/(2^index)
  weighted_temp <- (avg_temperatures * w)
  return(weighted_temp)
}
cleaned_temp_data$weighted_city_avg_temp <- mapply(weighted_avg_func, avg_temperatures = cleaned_temp_data$city_avg_temp, year = cleaned_temp_data$year)
```

# STEP 02 - EXPLORATORY DATA ANALYSIS

```{r echo=FALSE, warning = FALSE, message = FALSE}

```

**Analysis/Observation:** 

# STEP 03 - PREDICTIVE MODELLING

```{r echo=FALSE, warning = FALSE, message = FALSE}

```

**Analysis/Observation:** 

# STEP 04 - SPATIAL ANALYSIS

This section of the report presents various spatial analyses to investigate the correlation of city temperatures with population density and energy consumption using city temperature data from the 2010s. By visualizing and analyzing temperature data across cities worldwide, we aim to understand spatial patterns and identify areas with significant temperature density.

## Spatial Visualization: City Temperatures on a World Map

To begin, we plot average city temperatures from the 2010s on a world map, using a color gradient to represent temperature variations. This visualization helps in identifying broad spatial patterns in temperature distribution.

Relevance: This visualization highlights global temperature distribution, setting the stage for further spatial analyses of city temperatures.

```{r echo=FALSE, warning = FALSE, message = FALSE}

library(ggplot2)
library(viridis)
library(sf)
library(dplyr)

# World map visualization
ggplot() +
  # Plot the world map polygons as background
  geom_sf(data = world_map_df, fill = "grey80", color = "white") +
  # Plot the points with color indicating temperature
  geom_point(data = temp_points_2010s, aes(x = Longitude, y = Latitude, color = city_avg_temp), 
             size = 1, alpha = 0.8) +
  scale_color_viridis_c(option = "magma", name = "City Avg Temp (°C)") +
  theme_minimal() +
  labs(title = "City Temperature Across the World (2010s)",
       x = "Longitude",
       y = "Latitude")

```
# Point Pattern Analysis

Point pattern analysis examines the spatial distribution of city temperatures to detect clustering or dispersal patterns. We use kernel density estimation (KDE) to analyze the density of temperature data points.

## Preparing Data for Spatial Analysis
We filter temperature data for the 2010s, convert it into an sf object for spatial processing, and clean the data by removing invalid coordinate ranges.

```{r}
# Filter data for the 2010s
temp_data_2010s <- cleaned_temp_data %>%
  filter(year >= 2010 & year <= 2019) %>%
  dplyr::select(Longitude, Latitude, city_avg_temp) %>%
  filter(!is.na(Longitude), !is.na(Latitude), !is.na(city_avg_temp))

# Convert to sf object for spatial processing
temp_points_sf <- st_as_sf(temp_data_2010s, coords = c("Longitude", "Latitude"), crs = 4326)

# Clean coordinate data
temp_points_sf <- temp_points_sf %>%
  mutate(Longitude = st_coordinates(geometry)[, 1],
         Latitude = st_coordinates(geometry)[, 2]) %>%
  filter(Latitude >= -90, Latitude <= 90, Longitude >= -180, Longitude <= 180)
```

## Kernel Density Estimation (KDE)

KDE is performed to estimate the density of temperature data points, and contour lines are extracted to visualize the density distribution.

```{r}
# Compute the bandwidth matrix
H <- Hpi(st_coordinates(temp_points_sf))

# Perform KDE using the specified bandwidth matrix
temp_kde <- st_kde(temp_points_sf, H = H)

# Extract contour lines at specified levels
contours <- st_get_contour(temp_kde, cont = c(10, 25, 50, 75, 95))
contours$contlabel <- as.factor(contours$contlabel)
```

### Visualization of KDE and Density Contours

The KDE results and density contours are overlaid on a world map, alongside city temperature points.

Relevance: KDE and density contour analysis provide insights into high-temperature density regions, which are critical for understanding city temperature effects and their spatial patterns.

```{r}
ggplot() +
  # World map as background
  geom_sf(data = world_map_df, fill = "grey80", color = "white") +
  # Temperature points
  geom_sf(data = temp_points_sf, aes(color = city_avg_temp), size = 1, alpha = 0.7) +
  # Density contours
  geom_sf(data = contours, aes(fill = contlabel), color = "black", linetype = "solid") +
  # Color scales
  scale_color_viridis_c(name = "City Avg Temp (°C)") +
  scale_fill_viridis_d(name = "Density Contours") +
  # Labels and theme
  labs(title = "City Temperature Density and Contour Analysis (2010s)", 
       x = "Longitude", y = "Latitude") +
  theme_minimal()
```
### Spatial Analysis with tmap

Finally, we use tmap for an alternative visualization of temperature points and density contours, providing a detailed and interactive view.

Relevance: The tmap visualization offers a polished view of spatial data, enhancing interpretability for urban planning and climate studies.

```{r}
library(tmap)

# tmap visualization
tmap_mode("plot")
tm_shape(world_map) +
  tm_polygons(col = "grey80", border.col = "white") +
  tm_shape(temp_points_sf) +
  tm_dots(col = "city_avg_temp", palette = "viridis", size = 0.5, alpha = 0.7, title = "City Avg Temp (°C)") +
  tm_shape(contours) +
  tm_polygons(col = "contlabel", palette = "viridis", title = "Density Contours", alpha = 0.5) +
  tm_layout(title = "City Temperature Density and Contour Analysis (2010s)",
            legend.outside = TRUE,
            legend.outside.position = "right",
            frame = FALSE)

```
**Analysis/Observation:**

South America (Brazil & Argentina)
High Density: Clusters in central Brazil around cities like Brasília and further south towards São Paulo and Rio de Janeiro.
Temperature Range: Primarily warmer, with temperatures around 20°C to 40°C, indicated by yellow density contours.

North America (USA)
High Density: Significant clusters in the eastern United States, especially around the Midwest and Northeast regions, including cities like Chicago, New York, and Washington, D.C.
Temperature Range: Mostly in the range of 0°C to 20°C, represented by blue contours, with cooler clusters in the northern areas.

Europe
High Density: Central Europe shows considerable density, covering countries like Germany, France, and northern Italy. Major cities likely within these clusters include Berlin, Paris, and Milan.
Temperature Range: Predominantly in the 0°C to 20°C range, with some cooler temperatures extending north.

Middle East and North Africa
High Density: A strong concentration is seen around the Mediterranean region, including parts of Egypt and northern Saudi Arabia, as well as cities like Cairo and Riyadh.
Temperature Range: Warmer zones with 20°C to 40°C, marked by yellow contours.

South Asia (India)
High Density: India shows significant clustering, especially around northern and central areas, including cities like New Delhi and Mumbai.
Temperature Range: Mostly warm, between 20°C to 40°C, with the density reflecting a large urban population in warmer climates.

East Asia (China & Japan)
High Density: Clusters are noticeable around major urban centers like Beijing and Shanghai in China and Tokyo in Japan.
Temperature Range: Varied, with parts around 0°C to 20°C and some warmer regions in the south.

Australia
High Density: Clusters appear along the eastern coast, particularly around cities like Sydney and Melbourne.
Temperature Range: Warmer clusters around 0°C to 20°C, likely due to milder climate conditions in urban centers.


## Second Order Point Pattern Analysis

Second-order point pattern analysis examines the spatial relationships between points at varying distances. Ripley's K-function and the derived L-function are used to evaluate clustering or dispersion patterns in city temperature data.

### Moran's I and Study Window Definition

First, the spatial data is converted into a spatstat point pattern object, with a study window defined by the bounding box of the dataset. This step prepares the data for spatial statistical analyses.

Relevance: Defining a study window is crucial for ensuring the spatial extent aligns with the dataset and for calculating spatial statistics accurately.

```{r}
library(spatstat)
library(sf)

# Define study window using bounding box
bbox <- st_bbox(temp_points_sf)
temp_ppp <- ppp(
  x = st_coordinates(temp_points_sf)[, 1],
  y = st_coordinates(temp_points_sf)[, 2],
  window = owin(xrange = c(bbox["xmin"], bbox["xmax"]), yrange = c(bbox["ymin"], bbox["ymax"]))
)
```

### Ripley's K-Function Analysis

Ripley's K-function measures the cumulative number of neighboring points within increasing distances from each point. It is a standard tool for detecting clustering or regularity in spatial data.

Relevance: Ripley's K-function provides insight into the spatial dependence of temperature points, helping to identify clustering or uniformity patterns.

```{r}
# Calculate Ripley's K-function
K_result <- Kest(temp_ppp, correction = "Ripley")

# Plot Ripley's K-function
plot(K_result, main = "Ripley's K-function for Temperature Points",
     xlab = "Distance", ylab = "K(d)")
```
### L-Function Analysis

The L-function is a linearized transformation of Ripley's K-function. It adjusts for the effect of increasing area with distance, making the interpretation of clustering patterns more intuitive.

Relevance: The L-function refines the clustering analysis, making it easier to interpret deviations from complete spatial randomness.

```{r}
# Calculate and plot the L-function
L_result <- Lest(temp_ppp, correction = "Ripley")
plot(L_result, main = "L-function for Temperature Points",
     xlab = "Distance", ylab = "L(d) - d")
```
**Analysis/Observation:**

In the K-function plot, the observed values (black line) are consistently above the theoretical values (red dashed line). This indicates clustering of temperature points at multiple spatial scales, suggesting that cities with similar temperatures are more likely to be found near each other rather than being randomly distributed.

The L-function plot confirms the clustering seen in the K-function. The observed line lies above zero for most distances, further supporting the presence of spatial clustering among temperature points.

Together with the KDE analysis, the clustering indicated by the K- and L-functions suggests that certain regions experience similar temperature patterns, potentially due to Urban Heat Island effects or geographical factors.

# MAD Test for Ripley's K-Function and L-Function

The Mean Absolute Deviation (MAD) test is used to evaluate the deviation of observed Ripley’s K-function and L-function from complete spatial randomness (CSR). This test helps to determine whether the observed spatial patterns are significantly clustered or dispersed.

## MAD Test for Ripley’s K-Function

The MAD test for Ripley's K-function assesses whether the spatial distribution of temperature points deviates significantly from a random distribution.

```{r}
# Perform the MAD test for Ripley's K-function
mad_K <- mad.test(temp_ppp, Kest)
print(mad_K)
```

## MAD Test for the L-Function

Similarly, the MAD test for the L-function provides a refined evaluation of clustering or dispersion.

```{r}
# Perform the MAD test for the L-function
mad_L <- mad.test(temp_ppp, Lest)
print(mad_L)
```

**Analysis/Observation:**

Test Statistic: These values measure the maximum deviation between observed and theoretical patterns, indicating how much the observed pattern deviates from what would be expected under Complete Spatial Randomness (CSR)

P-value: A low p-value means there's a strong indication that the observed pattern is not random and that significant spatial structure (in this case clustering) exists.

This significant clustering reinforces the hypothesis that urbanization and energy consumption may contribute to Urban Heat Island effects.

# Spatial Attribute Analysis

This section combines spatial attributes, including population and energy consumption, to analyze their effects on urban temperatures.

## Data Preparation

Relevant datasets for population, energy consumption, and temperature were filtered and joined to enable spatial and statistical analysis.

```{r}
# Filter temperature data for the 2010s
cleaned_temp_data_2010s <- cleaned_temp_data %>%
  filter(year >= 2010 & year <= 2019)

# Prepare population data
population_data <- population_data %>%
  rename(Country = Country.Territory, Population_2015 = X2015.Population) %>%
  select(Country, Population_2015)

# Join population data with temperature data
cleaned_temp_data_2010s <- cleaned_temp_data_2010s %>%
  left_join(population_data, by = "Country") %>%
  filter(!is.na(Population_2015))

# Aggregate energy consumption by country and year
total_energy_data <- energy_data %>%
  group_by(Country, Year) %>%
  summarize(Total_Energy_Consumption = sum(Energy_consumption, na.rm = TRUE)) %>%
  ungroup()

# Convert `Year` to character and join energy data
total_energy_data <- total_energy_data %>%
  mutate(Year = as.character(Year))
cleaned_temp_data_2010s <- cleaned_temp_data_2010s %>%
  left_join(total_energy_data, by = c("Country", "year" = "Year")) %>%
  filter(!is.na(Total_Energy_Consumption))
```

## Spatial Weight Matrix and GWR Analysis

To analyze the spatial relationships, a subset of data was sampled, and spatial weight matrices were created. Geographically Weighted Regression (GWR) was applied to examine the local influence of population density and energy consumption on temperature.

```{r}
# Create spatial neighbors and weights
coords <- st_coordinates(cleaned_temp_data_2010s_sf)
set.seed(42)
sample_data <- cleaned_temp_data_2010s_sf %>% sample_frac(0.1)
coords_sample <- st_coordinates(sample_data)
neighbors_sample <- dnearneigh(coords_sample, 0, 100000)
weights_sample <- nb2listw(neighbors_sample, style = "W")

# Find optimal bandwidth for GWR
optimal_bw <- bw.gwr(city_avg_temp ~ Population_2015 + Total_Energy_Consumption, 
                     data = as(sample_data, "Spatial"), approach = "AICc")

# Run GWR model
gwr_model <- gwr.basic(city_avg_temp ~ Population_2015 + Total_Energy_Consumption, 
                       data = as(sample_data, "Spatial"), bw = optimal_bw)
print(gwr_model)

# Extract GWR coefficients
sample_data$gwr_pop_coef <- gwr_model$SDF$Population_2015
sample_data$gwr_energy_coef <- gwr_model$SDF$Total_Energy_Consumption
```

### Visualizing GWR Coefficients

The GWR coefficients for population density and energy consumption were visualized to highlight their spatial variability.

### Population Density Coefficient

```{r}
# Plot population density coefficient
tm_shape(world_map) + 
  tm_polygons(col = "grey90", border.col = "white", lwd = 0.5) +
  tm_shape(sample_data) +
  tm_dots("gwr_pop_coef", palette = "RdYlGn", title = "Population Density Coef", size = 0.2, alpha = 0.7) +
  tm_layout(main.title = "GWR Coefficient for Population Density on Temperature", legend.outside = TRUE)
```

### Energy Consumption Coefficient

```{r}
# Plot energy consumption coefficient
tm_shape(world_map) + 
  tm_polygons(col = "grey90", border.col = "white", lwd = 0.5) +
  tm_shape(sample_data) +
  tm_dots("gwr_energy_coef", palette = "Spectral", title = "Energy Consumption Coef", size = 0.2, alpha = 0.7) +
  tm_layout(main.title = "GWR Coefficient for Energy Consumption on Temperature", legend.outside = TRUE)
```

**Analysis/Observation:**

The GWR coefficients for Population Density indicates areas with higher coefficients (shown in green) where population density has a stronger effect on temperature, possibly due to urban heat island effects linked to population concentration.

We also see the GWR coefficients for Energy Consumption where areas with higher coefficients (in blue) suggest regions where energy consumption contributes significantly to temperature variations.

By plotting these coefficients, we can identify regional hotspots where urbanization and energy use have the most impact on temperature.


# Spatial Autocorrelation Analysis

Spatial autocorrelation evaluates whether similar temperature values are clustered. The spatial lag was calculated to observe dependency among temperature values.

```{r}
# Calculate spatial lag for temperature
sample_data$lagged_temp <- lag.listw(weights_sample, sample_data$city_avg_temp)

# Plot for City Average Temperature
city_avg_plot <- ggplot() +
  geom_sf(data = world_map, fill = "gray90", color = "gray50") +
  geom_sf(data = sample_data, aes(color = city_avg_temp), size = 1.5) +
  scale_color_viridis_c(option = "C", name = "City Avg Temperature", limits = c(-30, 40)) +
  labs(title = "City Average Temperature in Sampled Data") +
  theme_minimal()

# Plot for Spatially Lagged Temperature
lagged_temp_plot <- ggplot() +
  geom_sf(data = world_map, fill = "gray90", color = "gray50") +
  geom_sf(data = sample_data, aes(color = lagged_temp), size = 1.5) +
  scale_color_viridis_c(option = "C", name = "Lagged Temperature", limits = c(18.494, 18.499)) +
  labs(title = "Spatially Lagged Temperature") +
  theme_minimal()
```

**Analysis/Observation:**

In the City Average Temperature map, each point represents the average temperature for a specific city in our sample data. The colors range from purple, showing the coldest areas, to yellow, representing the warmest. We can clearly see hotter regions, especially in parts of the Middle East, Africa, and South America, while cooler regions are spread across northern latitudes.

In the Spatially Lagged Temperature map, each point reflects an average of temperatures in surrounding areas rather than just the individual city’s temperature. This lagged perspective smooths out local extremes, giving us a clearer sense of broader regional patterns. For example, we see a more consistent temperature gradient across continents, with fewer drastic variations compared to the left map.

By comparing these maps, we can distinguish between areas where temperature is strongly influenced by local factors versus regions where neighboring areas show similar temperatures. This spatial perspective helps us detect regional temperature clustering, which could highlight broader environmental trends or urban effects on climate, such as the Urban Heat Island effect.

In summary, the City Average Temperature map provides insight into local conditions, while the Spatially Lagged Temperature map emphasizes regional trends. Together, they offer a comprehensive view of how temperature varies across space and how neighboring areas influence these patterns.

----- Explanation ------

# CONCLUSION

## Conclusion

### Key Insights

This study has provided a comprehensive analysis of global temperature trends, the impact of urban attributes on temperature patterns, and spatial clustering effects. Key insights derived from the analysis are outlined below:

#### Global Temperature Trends

The exploratory analysis of temperature data over the past decade reveals a clear upward trend in global temperatures, consistent with the broader effects of global warming. This trend underscores the ongoing climate challenges faced by urban and rural regions alike, necessitating urgent attention and action to address rising temperatures worldwide.

#### Predictive Modelling

Through predictive modeling, the analysis identified that both energy consumption and population density have significant effects on urban temperatures. A polynomial model was found to offer an improved fit, capturing the non-linear relationships between these variables and temperature more effectively. This finding highlights the role of urban characteristics in amplifying temperature levels, particularly in densely populated and energy-intensive areas.

#### Spatial Analysis

The spatial analysis, employing Kernel Density Estimation (KDE) and spatial lag models, provided further insights into the distribution of high-temperature zones and the spread of the UHI effect.

Kernel Density Estimation (KDE) revealed concentrated high-temperature densities in urban areas, underscoring the presence of UHI effects. These areas demonstrate elevated temperatures compared to surrounding regions.

Spatial Lag Analysis demonstrated that temperature distributions are influenced not only by local urban characteristics but also by nearby urban areas. This finding indicates a regional spread of UHI effects, where temperature impacts extend beyond individual cities to affect neighboring regions as well.

### Implications for Sustainable Urban Planning

The findings from this analysis emphasize the critical need for sustainable urban planning strategies aimed at mitigating the impacts rising temperature trends in cities. Based on the results, the following recommendations are proposed for cities and urban planners:

Increase Green Spaces: Expanding green areas, such as parks and tree-lined streets, can help reduce local temperatures, improve air quality, and provide recreational spaces for residents.

Implement Energy-Efficient Infrastructure: Incorporating energy-efficient building designs, materials, and technologies can reduce urban energy consumption, which in turn can lower the urban temperature burden.
Enforce Sustainable Development Policies: Developing and enforcing policies that prioritize climate resilience and sustainability will support long-term mitigation of UHI effects. These policies may include incentives for green building practices, zoning laws that promote open spaces, and investment in renewable energy sources.

By adopting these strategies, urban areas can become more resilient to the effects of climate change, particularly the challenges posed by rising temperatures. These efforts are essential for creating healthier, more livable urban environments that are prepared for future climate scenarios.

----- Explanation ------

# EXTRA MILE

----- Explanation ------
